<!-- calendar.component.html -->
<!--
  Componente de calend√°rio / agenda com:
  - grade do m√™s
  - detalhes do dia
  - tabela de eventos
  - bot√£o de upload por evento
  - √°rea de upload (arquivo + enviar)
  - listagem de relat√≥rios enviados para cada evento
-->

<div class="agenda-header">
  <!-- Cabe√ßalho com nome da agenda e a√ß√£o de voltar -->
  <h2>
    <span (click)="voltar()" matTooltip="Voltar" style="cursor:pointer;">
      Agenda de {{ nomeAgenda }}
    </span>
  </h2>
</div>

<!-- Cabe√ßalho do calend√°rio com navega√ß√£o de m√™s -->
<div class="calendar-header">
  <!-- Bot√£o m√™s anterior -->
  <button (click)="prevMonth()">‚óÄ</button>
  <!-- Exibe m√™s e ano atual -->
  <h2>{{ currentDate | date: 'MMMM - yyyy' }}</h2>
  <!-- Bot√£o pr√≥ximo m√™s -->
  <button (click)="nextMonth()">‚ñ∂</button>
</div>

<!-- Grade do calend√°rio: itera 'days' gerado em TS -->
<div class="calendar-grid">
  <div class="day" *ngFor="let d of days" (click)="onDayClick(d)">
    <!-- se 'd.day' for null mostramos c√©lula vazia -->
    <div *ngIf="d.day">
      <!-- n√∫mero do dia -->
      <strong>{{ d.day }}</strong>

      <!-- eventos do dia: iteramos d.events -->
      <div class="event" *ngFor="let e of d.events" [ngClass]="{ 'concluido': e.status === 'completed' }">
        <!-- t√≠tulo do evento -->
        <span>{{ e.title }}</span><br>
        <!-- mostra local se houver -->
        <span *ngIf="e.location">üìç {{ e.location }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Detalhes do dia selecionado -->
<div class="day-details" *ngIf="selectedDay">
  <h3>Eventos do dia {{ selectedDay.day }}:</h3>

  <!-- Se o dia possui eventos, mostramos a tabela -->
  <div *ngIf="selectedDay.events.length > 0; else noEvents">
    <table mat-table [dataSource]="selectedDay.events" class="event-table" *ngIf="selectedDay.events.length > 0">

      <!-- Coluna: T√≠tulo -->
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>T√≠tulo</th>
        <td mat-cell *matCellDef="let e">{{ e.title }}</td>
      </ng-container>

      <!-- Coluna: In√≠cio -->
      <ng-container matColumnDef="start_time">
        <th mat-header-cell *matHeaderCellDef>In√≠cio</th>
        <td mat-cell *matCellDef="let e">{{ e.start_time | date: 'shortTime' }}</td>
      </ng-container>

      <!-- Coluna: Fim -->
      <ng-container matColumnDef="end_time">
        <th mat-header-cell *matHeaderCellDef>Fim</th>
        <td mat-cell *matCellDef="let e">
          {{ e.end_time ? (e.end_time | date: 'shortTime') : '‚Äî' }}
        </td>
      </ng-container>

      <!-- Coluna: Local -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>Local</th>
        <td mat-cell *matCellDef="let e">{{ e.location || '‚Äî' }}</td>
      </ng-container>

      <!-- Coluna: A√ß√µes -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>A√ß√µes</th>
        <td mat-cell *matCellDef="let e">
          <!-- visualizar evento (sempre vis√≠vel) -->
          <button mat-icon-button color="primary" (click)="visualizarEvento(e)" matTooltip="Visualizar evento">
            <mat-icon>visibility</mat-icon>
          </button>

          <!-- concluir evento (sempre vis√≠vel) -->
          <button mat-icon-button color="accent" (click)="concluirEvento(e)" matTooltip="Concluir">
            <mat-icon>check_circle</mat-icon>
          </button>

          <!-- excluir (apenas se tipo == 'client' e evento n√£o conclu√≠do) -->
          <button mat-icon-button color="warn"
                  *ngIf="tipo === 'client'"
                  [disabled]="e.end_time"
                  (click)="excluirEvento(e)"
                  matTooltip="Excluir (desabilitado se conclu√≠do)">
            <mat-icon>delete</mat-icon>
          </button>

          <!-- bot√£o de UPLOAD do relat√≥rio - vis√≠vel apenas para usu√°rio associado (tipo === 'user') -->
          <button mat-icon-button color="primary"
                  *ngIf="tipo === 'user'"
                  (click)="abrirUpload(e)"
                  matTooltip="Enviar relat√≥rio">
            <mat-icon>upload</mat-icon>
          </button>

          <!-- bot√£o para tech lead abrir painel de relat√≥rios (vis√≠vel se for tech lead) -->
          <button mat-icon-button color="secondary"
                  *ngIf="isTechLead"
                  (click)="abrirRelatorios(e)"
                  matTooltip="Ver relat√≥rios do evento">
            <mat-icon>description</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Cabe√ßalho e linhas (defini√ß√£o do Angular Material Table) -->
      <tr mat-header-row *matHeaderRowDef="['title', 'start_time', 'end_time', 'location', 'actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['title', 'start_time', 'end_time', 'location', 'actions']"></tr>
    </table>
  </div>

  <!-- Template mostrado quando n√£o h√° eventos -->
  <ng-template #noEvents>
    <p>N√£o h√° eventos para este dia.</p>
  </ng-template>

  <!-- ---------- √Årea de upload vis√≠vel quando 'eventoUpload' est√° preenchido ---------- -->
  <div *ngIf="eventoUpload" class="upload-panel">
    <h4>Enviar relat√≥rio para: {{ eventoUpload.title }}</h4>

    <!-- input file (seleciona 1 arquivo) -->
    <input type="file" (change)="selecionarArquivo($event)" />

    <!-- campo para notas/opcionais -->
    <mat-form-field appearance="fill" style="display:block; margin-top:8px;">
      <mat-label>Notas (opcional)</mat-label>
      <input matInput [(ngModel)]="uploadNotes" name="uploadNotes" />
    </mat-form-field>

    <!-- bot√µes enviar / cancelar -->
    <div style="margin-top:8px;">
      <button mat-raised-button color="primary" (click)="enviarArquivo()" [disabled]="!arquivoSelecionado">
        Enviar
      </button>
      <button mat-button (click)="cancelarUpload()">Cancelar</button>
    </div>

    <!-- barra de progresso simples -->
    <div *ngIf="uploading" style="margin-top:8px;">
      <p>Enviando... {{ uploadProgress }}%</p>
    </div>
  </div>

  <!-- ---------- Lista de relat√≥rios do dia/evento (vis√≠vel se tiver relat√≥rios carregados) ---------- -->
  <div *ngIf="relatorios.length > 0" style="margin-top:16px;">
    <h4>Relat√≥rios enviados para o dia:</h4>
    <ul>
      <li *ngFor="let r of relatorios">
        <!-- nome do arquivo + status -->
        {{ r.file_name }} ‚Äî {{ r.status }}

        <!-- bot√£o baixar (tenta buscar do backend) -->
        <button mat-button (click)="baixarRelatorio(r)">Baixar</button>

        <!-- se for tech lead e status == pending, mostra aprovar/rejeitar -->
        <ng-container *ngIf="isTechLead && r.status === 'pending'">
          <button mat-button color="primary" (click)="aprovarRelatorio(r, true)">Aprovar</button>
          <button mat-button color="warn" (click)="aprovarRelatorio(r, false)">Rejeitar</button>
        </ng-container>

        <!-- mostra quem revisou -->
        <span *ngIf="r.reviewed_by"> ‚Äî Revisado por: {{ r.reviewed_by_name || r.reviewed_by }}</span>
      </li>
    </ul>
  </div>

</div>
