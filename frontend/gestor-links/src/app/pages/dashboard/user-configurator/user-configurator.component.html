<mat-tab-group (selectedTabChange)="onTabChange($event)">

  <!-- Aba Dados Cadastrais -->
  <mat-tab label="Dados Cadastrais">
    <div class="dados-grid">

      <div class="form-field">
        <label>Nome:</label>
        <input [(ngModel)]="user.name" />
      </div>

      <div class="form-field">
        <label>Email (login):</label>
        <input [(ngModel)]="user.email" />
      </div>

      <div class="form-field">
        <label>Email cobrança:</label>
        <input [(ngModel)]="user.billing_email" />
      </div>

      <div class="form-field">
        <label>Email financeiro:</label>
        <input [(ngModel)]="user.finance_email" />
      </div>

      <div class="form-field">
        <label>Empresa:</label>
        <input [(ngModel)]="user.company_name" />
      </div>

      <div class="form-field">
        <label>CNPJ:</label>
        <input [(ngModel)]="user.cnpj" />
      </div>

      <div class="form-field">
        <label>CEP:</label>
        <input [(ngModel)]="user.cep" (blur)="buscarCep()" />
      </div>

      <div class="form-field">
        <label>Rua:</label>
        <input [(ngModel)]="user.street" />
      </div>

      <div class="form-field">
        <label>Número:</label>
        <input [(ngModel)]="user.number" />
      </div>

      <div class="form-field">
        <label>Bairro:</label>
        <input [(ngModel)]="user.neighborhood" />
      </div>

      <div class="form-field">
        <label>Cidade:</label>
        <input [(ngModel)]="user.city" />
      </div>

      <div class="form-field">
        <label>Estado:</label>
        <input [(ngModel)]="user.state" />
      </div>

    </div>
  </mat-tab>

  <!-- Aba Recebimento -->
  <mat-tab label="Recebimento">
    <div class="dados-grid">

      <div class="form-field">
        <label>Banco:</label>
        <input [(ngModel)]="user.bank_name" />
      </div>

      <div class="form-field">
        <label>Agência:</label>
        <input [(ngModel)]="user.bank_agency" />
      </div>

      <div class="form-field">
        <label>Conta:</label>
        <input [(ngModel)]="user.bank_account" />
      </div>

      <div class="form-field">
        <label>PIX:</label>
        <input [(ngModel)]="user.pix_key" />
      </div>

    </div>
  </mat-tab>

  <!-- Aba Módulos -->
  <mat-tab label="Módulos">
    <div class="tab-content">
      <h4>Adicionar Módulo</h4>

        <div class="add-module-grid">

          <!-- Autocomplete de código/label -->
          <mat-form-field appearance="outline">
            <mat-label>Módulo</mat-label>
            <input
              type="text"
              matInput
              [formControl]="moduleControl"
              [matAutocomplete]="auto"
              placeholder="Digite código ou nome">

            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onModuleSelected($event.option.value)">
              <mat-option *ngFor="let mod of filteredModules | async" [value]="mod.code">
                <strong>{{ mod.code }}</strong> — {{ mod.label }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <!-- Campo label preenchido automaticamente -->
          <mat-form-field appearance="outline">
            <mat-label>Descrição</mat-label>
            <input matInput [(ngModel)]="selectedModuleLabel" readonly>
          </mat-form-field>

          <!-- Score -->
          <mat-form-field appearance="outline">
            <mat-label>Proficiência</mat-label>
            <mat-select #score>
              <mat-option *ngFor="let s of [1,2,3,4,5]" [value]="s">{{ s }}</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Botão -->
          <button class="custom-save-button" (click)="addModule(moduleControl.value|| '', score.value)">
            Adicionar
          </button>

        </div>
      <table>
        <tr>
          <th>Código</th>
          <th>Descrição</th>
          <th>Ação</th>
        </tr>

        <tr *ngFor="let mod of user.modulos; let i = index">
          <td>{{ mod.module_code }}</td>
          <td>{{ mod.label }}</td>
          <td>
            <button class="remove-button" (click)="removeModule(i)">
              <mat-icon class="remove_circle_outline">delete</mat-icon>
            </button>
          </td>
        </tr>
      </table>

      



    </div>
  </mat-tab>

  <!-- Aba Contratos -->
  <mat-tab label="Contratos" *ngIf="featureContratosReady">
    <div class="tab-content">
      <table>
        <tr><th>Tipo</th><th>Valor Base</th><th>Multiplicador</th><th>Validade</th></tr>
        <tr *ngFor="let c of userContracts">
          <td>{{ c.contract_type }}</td>
          <td>{{ c.base_value }}</td>
          <td>{{ c.multiplier }}</td>
          <td>{{ c.valid_from }} - {{ c.valid_to }}</td>
        </tr>
      </table>

      <h4>Novo Contrato</h4>
      <button (click)="addContract({contract_type:'full_time', base_value:1000, multiplier:1, valid_from:'2025-01-01'})">
        Adicionar
      </button>
    </div>
  </mat-tab>

  <!-- Aba Invoices -->
  <mat-tab label="Invoices" *ngIf="featureInvoicesReady">
    <div class="tab-content">
      <table>
        <tr><th>Número</th><th>Valor</th><th>Status</th><th>Arquivo</th></tr>
        <tr *ngFor="let inv of userInvoices">
          <td>{{ inv.invoice_number }}</td>
          <td>{{ inv.amount }}</td>
          <td>{{ inv.status }}</td>
          <td><a *ngIf="inv.file_path" [href]="inv.file_path" target="_blank">Ver NF</a></td>
        </tr>
      </table>

      <h4>Nova Invoice</h4>
      <input #invoiceNumber placeholder="Número" />
      <input #invoiceAmount type="number" placeholder="Valor" />
      <input type="file" (change)="onFileSelected($event)" />
      <button (click)="addInvoice({invoice_number: invoiceNumber.value, amount: invoiceAmount.value})">
        Adicionar
      </button>
    </div>
  </mat-tab>

  <!-- Aba Senha (inalterada) -->
  <mat-tab label="Senha">
    <div class="tab-content senha-tab">
      <h4>Alterar Senha</h4>

      <mat-form-field appearance="outline">
        <mat-label>Senha Atual</mat-label>
        <input matInput [type]="hideCurrent ? 'password' : 'text'" [(ngModel)]="currentPassword" required>
        <mat-icon matSuffix (click)="hideCurrent = !hideCurrent" class="eye-icon">
          {{ hideCurrent ? 'visibility_off' : 'visibility' }}
        </mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nova Senha</mat-label>
        <input matInput [type]="hideNew ? 'password' : 'text'" [(ngModel)]="newPassword" required>
        <mat-icon matSuffix (click)="hideNew = !hideNew" class="eye-icon">
          {{ hideNew ? 'visibility_off' : 'visibility' }}
        </mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Repita Nova Senha</mat-label>
        <input matInput [type]="hideRepeat ? 'password' : 'text'" [(ngModel)]="repeatPassword" required>
        <mat-icon matSuffix (click)="hideRepeat = !hideRepeat" class="eye-icon">
          {{ hideRepeat ? 'visibility_off' : 'visibility' }}
        </mat-icon>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="changePassword()">Alterar</button>
    </div>
  </mat-tab>

</mat-tab-group>

<!-- Botão Salvar -->
<div class="save-container" *ngIf="selectedTabIndex !== 3">
  <button class="custom-save-button" (click)="updateUser()">
    <mat-icon class="save-icon">save</mat-icon>
    Salvar
  </button>
</div>
