<div *ngIf="loading">Loading...</div>
<h2 *ngIf="groupBy === 'client'">Pendências agrupadas por Cliente</h2>
<h2 *ngIf="groupBy === 'day'">Pendências agrupadas por Dia</h2>
<div *ngIf="error" style="color: red">
  {{ error }}
</div>


<mat-accordion multi>
  <mat-expansion-panel *ngFor="let group of groupedSchedules">
    <mat-expansion-panel-header>
      <mat-panel-title>
        {{ group.client_name }}
      </mat-panel-title>
      <mat-panel-description>
        {{ group.schedules.length }} pending item(s)
      </mat-panel-description>
    </mat-expansion-panel-header>

    <table mat-table [dataSource]="group.schedules" class="mat-elevation-z2">
      <!-- Date -->
      <ng-container matColumnDef="start_time">
        <th mat-header-cell *matHeaderCellDef> Date </th>
        <td mat-cell *matCellDef="let s"> {{ s.start_time | date:'dd/MM/yyyy' }} </td>
      </ng-container>

      <!-- User -->
      <ng-container matColumnDef="user_name">
        <th mat-header-cell *matHeaderCellDef> User </th>
        <td mat-cell *matCellDef="let s"> {{ s.user_name }} </td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Status </th>
        <td mat-cell *matCellDef="let s"> {{ s.status }} </td>
      </ng-container>

      <!-- Actions -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Actions </th>
        <td mat-cell *matCellDef="let s">
          <!-- Download / Visualizar -->
          <button mat-icon-button color="accent" *ngIf="s.status === 'pending'" (click)="onDownload(s)">
            <mat-icon>download</mat-icon>
          </button>
          <button mat-icon-button color="primary" *ngIf="s.status === 'pending'" (click)="approve(s.schedule_id, s.user_id)">
            <mat-icon>check_circle</mat-icon>
          </button>
          <button mat-icon-button color="warn" *ngIf="s.status === 'pending'" (click)="reject(s.schedule_id, s.user_id)">
            <mat-icon>cancel</mat-icon>
          </button>
          <button mat-icon-button color="accent" *ngIf="s.status === 'missing'" (click)="remind(s.schedule_id, s.user_id)">
            <mat-icon>notifications</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['start_time', 'user_name', 'status', 'actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['start_time', 'user_name', 'status', 'actions']"></tr>
    </table>
  </mat-expansion-panel>
</mat-accordion>




<mat-accordion>
  <mat-expansion-panel *ngFor="let date of (groupedReports | keyvalue)">
    <mat-expansion-panel-header>
      <mat-panel-title>
        {{ date.key | date:'dd/MM/yyyy' : 'UTC' }}
      </mat-panel-title>
      <mat-panel-description>
        {{ date.value.length }} pending item(s)
      </mat-panel-description>
    </mat-expansion-panel-header>

    <!-- Tabela dentro do painel -->
    <table mat-table [dataSource]="date.value" class="mat-elevation-z1">

      <!-- Empresa -->
      <ng-container matColumnDef="client_name">
        <th mat-header-cell *matHeaderCellDef> Empresa </th>
        <td mat-cell *matCellDef="let report"> {{ report.client_name }} </td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Status </th>
        <td mat-cell *matCellDef="let report"> 
        <span [ngClass]="{
          'status-missing': report.status === 'missing',
          'status-pending': report.status === 'pending',
          'status-rejected': report.status === 'rejected'
        }">
          {{ report.status }}
        </span>  
        </td>
      </ng-container>

      <!-- Ações -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Ações </th>
        <td mat-cell *matCellDef="let report">
          <button mat-icon-button color="primary" (click)="onUpload(report)">
            <mat-icon>upload</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Header e linhas -->
      <tr mat-header-row *matHeaderRowDef="['client_name','status','actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['client_name','status','actions']"></tr>
    </table>
  </mat-expansion-panel>
</mat-accordion>

<div *ngIf="!loading && (
      (groupBy === 'client' && groupedSchedules.length === 0) ||
      (groupBy === 'day' && (groupedReports | keyvalue).length === 0)
    )" class="empty-state">

  
  

  <img src="assets/images/relax.png" alt="No schedules found" />
</div>