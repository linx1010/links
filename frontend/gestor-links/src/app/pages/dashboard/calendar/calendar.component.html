<div class="agenda-header">
  <h2>
    <span (click)="voltar()" matTooltip="Voltar" style="cursor:pointer;">
      Agenda de {{ nomeAgenda }}
    </span>
  </h2>
</div>

<!-- Cabe√ßalho do calend√°rio -->
<div class="calendar-header">
  <button (click)="prevMonth()">‚óÄ</button>
  <h2>{{ currentDate | date: 'MMMM - yyyy' }}</h2>
  <button (click)="nextMonth()">‚ñ∂</button>
</div>

<!-- Grade do calend√°rio -->
<div class="calendar-grid">
  <div class="day" *ngFor="let d of days" (click)="onDayClick(d)">
    <div *ngIf="d.day">
      <strong>{{ d.day }}</strong>
      <div class="event" *ngFor="let e of d.events" [ngClass]="{ 'concluido': e.status === 'completed' }">
        <span>{{ e.title }}</span><br>
        <span *ngIf="e.location">üìç {{ e.location }}</span>
      </div>
    </div>
  </div>
</div>
<div class="upload-relatorio" *ngIf="eventoUpload">
  <h4>Upload de relat√≥rio para {{ eventoUpload.title }}</h4>

  <!-- Sele√ß√£o de arquivo -->
  <input type="file" (change)="selecionarArquivo($event)" />

  <!-- Notas -->
  <mat-form-field appearance="fill">
    <mat-label>Notas</mat-label>
    <textarea matInput [(ngModel)]="uploadNotes"></textarea>
  </mat-form-field>

  <!-- Bot√µes -->
  <button mat-raised-button color="primary" (click)="enviarArquivo()" 
          [disabled]="!arquivoSelecionado || uploading">
    Enviar
  </button>
  <button mat-button color="warn" (click)="cancelarUpload()">Cancelar</button>

  <!-- Barra de progresso -->
  <mat-progress-bar *ngIf="uploading" mode="determinate" [value]="uploadProgress"></mat-progress-bar>
</div>
<!-- Detalhes do dia selecionado -->
<div class="day-details" *ngIf="selectedDay">
  <h3>Eventos do dia {{ selectedDay.day }}:</h3>

  

  <!-- Tabela de eventos -->
  <div *ngIf="selectedDay.events.length > 0; else noEvents">
    <table mat-table [dataSource]="selectedDay.events" class="event-table">
      <!-- Colunas -->
      <ng-container *ngIf="tipo === 'user'" matColumnDef="client_name">
        <th mat-header-cell *matHeaderCellDef>Cliente</th>
        <td mat-cell *matCellDef="let e">{{ e.client_name }}</td>
      </ng-container>
      <ng-container *ngIf="tipo === 'client'" matColumnDef="techlead_name">
        <th mat-header-cell *matHeaderCellDef>Tech Lead</th>
        <td mat-cell *matCellDef="let e">{{ e.techlead_name }}</td>
      </ng-container>

      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>T√≠tulo</th>
        <td mat-cell *matCellDef="let e">{{ e.title }}</td>
      </ng-container>

      <ng-container matColumnDef="start_time">
        <th mat-header-cell *matHeaderCellDef>In√≠cio</th>
        <td mat-cell *matCellDef="let e">{{ e.start_time | date: 'shortTime' }}</td>
      </ng-container>

      <ng-container matColumnDef="end_time">
        <th mat-header-cell *matHeaderCellDef>Fim</th>
        <td mat-cell *matCellDef="let e">{{ e.end_time ? (e.end_time | date: 'shortTime') : '‚Äî' }}</td>
      </ng-container>

      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>Local</th>
        <td mat-cell *matCellDef="let e">{{ e.location || '‚Äî' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>A√ß√µes</th>
        <td mat-cell *matCellDef="let e">
          <button mat-icon-button color="primary" (click)="visualizarEvento(e)" matTooltip="Visualizar">
            <mat-icon>visibility</mat-icon>
          </button>
          <button mat-icon-button color="accent" (click)="concluirEvento(e)" matTooltip="Concluir">
            <mat-icon>check_circle</mat-icon>
          </button>
          <button mat-icon-button color="primary" *ngIf="tipo === 'user' || isTechLead || isAdmin" 
          (click)="abrirUpload(e)" matTooltip="Enviar relat√≥rio">
          <mat-icon>upload</mat-icon>
        </button>
        <button mat-icon-button color="secondary" *ngIf="isTechLead" (click)="abrirRelatorios(e)" matTooltip="Ver relat√≥rios">
          <mat-icon>description</mat-icon>
        </button>
        <button mat-icon-button color="secondary" *ngIf="tipo === 'client'"  (click)="abrirDialogReplicacao(e)" matTooltip="Replicar agenda para dias seguintes">
          <mat-icon>event_repeat</mat-icon>
        </button>
        <button mat-icon-button color="warn" *ngIf="tipo === 'client'" [disabled]="e.status === 'completed'" (click)="excluirEvento(e)" matTooltip="Excluir">
          <mat-icon>delete</mat-icon>
        </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

    </table>
  </div>

  <ng-template #noEvents>
    <p>N√£o h√° eventos para este dia.</p>
  </ng-template>
</div>
<!-- üì§ Formul√°rio de upload de relat√≥rio -->


<!-- ‚ûï Formul√°rio para adicionar evento -->
<div class="add-event" *ngIf="canCreateAgenda">
  <h4>Adicionar novo evento</h4>

  <form (ngSubmit)="submitEvento()" #eventoForm="ngForm">
    <mat-form-field appearance="fill">
      <mat-label>T√≠tulo</mat-label>
      <input matInput [(ngModel)]="formEvento.title" name="title" required />
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Descri√ß√£o</mat-label>
      <textarea matInput [(ngModel)]="formEvento.description" name="description"></textarea>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Turno</mat-label>
      <mat-select [(ngModel)]="formEvento.turno" name="turno" required>
        <mat-option value="integral">Integral</mat-option>
        <mat-option value="manha">Manh√£</mat-option>
        <mat-option value="tarde">Tarde</mat-option>
      </mat-select>
    </mat-form-field>


    <mat-form-field appearance="fill">
      <mat-label>Participantes</mat-label>
      <mat-select [(ngModel)]="formEvento.user_id" name="user_id" multiple>
        <mat-option *ngFor="let u of recursos" [value]="u.id">{{ u.name }}</mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" type="submit" [disabled]="!eventoForm.form.valid">
      Adicionar Evento
    </button>
  </form>
</div>


<!-- Dialog de replica√ß√£o -->
<ng-template #dialogReplicacao>
  <h2 mat-dialog-title>Cadastro em bloco</h2>
  <mat-dialog-content>
    <!-- T√≠tulo -->
    <mat-form-field appearance="fill" style="display:block;">
      <mat-label>T√≠tulo</mat-label>
      <input matInput [(ngModel)]="formEvento.title" name="title" required />
    </mat-form-field>
    
    <!-- Turno -->
    <mat-form-field appearance="fill">
      <mat-label>Turno</mat-label>
      <mat-select [(ngModel)]="formEvento.turno" name="turno" required>
        <mat-option value="manha">Manh√£</mat-option>
        <mat-option value="tarde">Tarde</mat-option>
        <mat-option value="integral">Integral</mat-option>
      </mat-select>
    </mat-form-field>

    <!-- Descri√ß√£o -->
    <mat-form-field appearance="fill" style="display:block;">
      <mat-label>Descri√ß√£o</mat-label>
      <textarea matInput [(ngModel)]="formEvento.description" name="description"></textarea>
    </mat-form-field>

    <!-- Participantes com checkboxes -->
      <mat-form-field appearance="fill" style="display:block;">
    <mat-label>Participantes</mat-label>
    <mat-select [(ngModel)]="formEvento.user_id" name="user_id" multiple>
      <mat-option *ngFor="let r of recursos" [value]="r.id">
        {{ r.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>


    <!-- üîÅ Intervalo de datas -->
    <mat-form-field appearance="fill" style="display:block;">
      <mat-label>Per√≠odo</mat-label>
      <mat-date-range-input [rangePicker]="picker">
        <input matStartDate [(ngModel)]="dateRange.start" name="startDate" placeholder="Data inicial">
        <input matEndDate [(ngModel)]="dateRange.end" name="endDate" placeholder="Data final">
      </mat-date-range-input>
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-date-range-picker #picker></mat-date-range-picker>
    </mat-form-field>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancelar</button>
    <button mat-raised-button color="primary" (click)="confirmarReplicacao()">Confirmar</button>
  </mat-dialog-actions>
</ng-template>

